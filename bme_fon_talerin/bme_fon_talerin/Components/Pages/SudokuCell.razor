<div class="@Classes" id='@($"cell-{Row}-{Column}")' tabindex='@($"{Row}{Column}")' onfocus="select('@($"cellhighlight-{Row}-{Column}")')" onfocusout="deselect('@($"cellhighlight-{Row}-{Column}")')">
    <span class="cellvalue" style="background-color: @(Value == null ? "transparent" : "inherit")">
        @(Value == null ? "" : Value)
    </span>
    <span class="cellpencil">
        <span class="cellpencildata">
            @PencilMarks
        </span>
    </span>
    <span id=@($"cellhighlight-{Row}-{Column}") class="cellhighlight" hidden>
    </span>
</div>

@code {
    [Parameter]
    public SudokuGrid Parent { get; set; }
    [Parameter]
    public int Row { get; set; }
    [Parameter]
    public int Column { get; set; }
    [Parameter]
    public int? Value { get; set; }
    [Parameter]
    public string GridType { get; set; }
    [Parameter]
    public Random Rand { get; set; }

    private string Classes { get; set; } = "";
    private string PencilMarks
    {
        get { return string.Join("", PencilMarkList.OrderBy(x => x)); }
    }
    private HashSet<int> PencilMarkList { get; set; } = new();

    private string TempClasses { get; set; } = "";

    private bool Changeable { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Parent.Cells[Row][Column] = this;
        Changeable = Value == null;

        SetupClasses();
    }

    private void SetupClasses()
    {
        Classes = "cell";
        Classes += Value == null ? "" : " value";
        if (GridType == "Box")
        {
            Classes += Row % 3 == 0 ? " bordertop" : "";
            Classes += Row % 3 == 2 ? " borderbottom" : "";
            Classes += Column % 3 == 0 ? " borderleft" : "";
            Classes += Column % 3 == 2 ? " borderright" : "";
        }
    }

    public void UpdateValue(int value)
    {
        if (!Changeable)
        {
            return;
        }
        Value = Value == value ? null : value;

        StateHasChanged();
    }

    public void UpdatePencilMarks(int value)
    {
        if (!Changeable)
        {
            return;
        }

        if (!PencilMarkList.Add(value))
        {
            PencilMarkList.Remove(value);
        }

        StateHasChanged();
    }

    public void ClearCell()
    {
        if (!Changeable)
        {
            return;
        }
        if (Value != null)
        {
            PencilMarkList.Clear();
        }
        Value = null;

        StateHasChanged();
    }
}